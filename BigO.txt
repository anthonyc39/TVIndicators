//@version=6
//Made by Anthony Colajezzi

indicator("Big O", overlay=true, max_boxes_count=500, max_lines_count=500)

// === LONG (Bull) SETTINGS ===
section_long = "LONG ALERT"
enableLong = input.bool(true, "Long Alerts", group=section_long)
bullTriangleColor = input.color(#4caf50, "Triangle Color", group=section_long)
brokenBearOpenLineColor = input.color(color.white, "Broken Line Color", group=section_long)
bullishFVGBoxColor = input.color(color.rgb(37, 153, 250, 64), "Bullish FVG Box Color", group=section_long)
bullFVGTradedColor = input.color(color.rgb(29, 173, 7, 64), "FVG Traded-Back-Into Color", group=section_long)
invalidBullFVGColor = input.color(color.rgb(128, 128, 128, 64), "Invalid Bullish FVG Color", group=section_long)
bullFVGBoxLength = input.int(400, "FVG Box Projection (1 - 400 Bars)", minval=1, maxval=400, group=section_long)
bullFVG50MidColor = input.color(color.white, "FVG 50% Retracement Line Color", group=section_long)

// === SHORT (Bear) SETTINGS ===
section_short = "SHORT ALERT"
enableShort = input.bool(true, "Short Alerts", group=section_short)
bearTriangleColor = input.color(#e57373, "Triangle Color", group=section_short)
brokenBullOpenLineColor = input.color(color.white, "Broken Line Color", group=section_short)
bearishFVGBoxColor = input.color(color.rgb(242, 148, 27, 64), "Bearish FVG Box Color", group=section_short)
bearFVGTradedColor = input.color(color.rgb(242, 64, 27, 64), "FVG Traded-Back-Into Color", group=section_short)
invalidBearFVGColor = input.color(color.rgb(128, 128, 128, 64), "Invalid Bearish FVG Color", group=section_short)
bearFVGBoxLength = input.int(400, "FVG Box Projection (1 - 400 Bars)", minval=1, maxval=400, group=section_short)
bearFVG50MidColor = input.color(color.white, "FVG 50% Retracement Line Color", group=section_short)

// === NEW: FVG size filter ===
section_fvg_filter = "FVG Size Filter"
hideLargeBullFVGs = input.bool(false, "Hide Large Bullish FVGs", group=section_fvg_filter)
bullMaxFVGSize = input.int(120, "Max Bullish FVG size (ticks)", minval=1, group=section_fvg_filter)
hideLargeBearFVGs = input.bool(false, "Hide Large Bearish FVGs", group=section_fvg_filter)
bearMaxFVGSize = input.int(120, "Max Bearish FVG size (ticks)", minval=1, group=section_fvg_filter)

// === COMMON ===
input_in_status_line = input.bool(true, "Inputs in status line", inline="status")

// ========== STATE MACHINES & STORAGE ========== 

// --- Bullish FVG System ---
var int bullState_idle = 0, bullState_bear_run = 1, bullState_bear_log = 2, bullState_bull_reversal = 3
var int bullState = bullState_idle
var int bearStreak = 0
var int lastBearStreak = 0
var float[] bearOpens = array.new_float()
var int[] bearBarIndexes = array.new_int()

// bull FVG storage
var box[] bullFVGBoxes = array.new_box()
var float[] bullFVGHighs = array.new_float()
var float[] bullFVGLows = array.new_float()
var line[] bullFVG50Lines = array.new_line()
var int[] bullFVGIds = array.new_int()
var bool[] bullFVGTraded = array.new_bool()
var int[] bullFVGStartBarIdx = array.new_int()
var bool[] bullFVGInvalidated = array.new_bool()

var bool bullCanPlotFVG = false
var int bullReversalId = 0
var line bullLastLine = na
var label bullLastTriangle = na
var bool bullReversalComplete = false
var int bullPrevMaxIdx = na
var bool bullPendingSignalFVG = false
var bool bullBrokeFirstBearOpen = false
var bool bullWaitingAfterFirstBreak = false
var bool bullJustEnteredIdle = false
var bool bullJustEnteredIdleHadSignal = false
var int bullReversalCompletedOn = na

// --- FIXED / MISSING declarations for bull side
var int bullReversalEndedOn = na
var int bullBarsAfterReversal = 0
var bool bullJustConfirmedReversal = false

// pending-signal arrays for bull side
var int[] bullSignalBars = array.new_int()
var int[] bullSignalReversalIds = array.new_int()
var bool[] bullSignalFVGCreated = array.new_bool()

// Arrays to track all drawn lines/triangles (declare once, push object ids into them)
var line[] bullAllLines = array.new_line()
var label[] bullAllTriangles = array.new_label()

// --- Bearish FVG System ---
var int bearState_idle = 0, bearState_bull_run = 1, bearState_bull_log = 2, bearState_bear_reversal = 3
var int bearState = bearState_idle
var int bullStreak = 0
var int lastBullStreak = 0
var float[] bullOpens = array.new_float()
var int[] bullBarIndexes = array.new_int()

// bear FVG storage
var box[] bearFVGBoxes = array.new_box()
var float[] bearFVGHighs = array.new_float()
var float[] bearFVGLows = array.new_float()
var line[] bearFVG50Lines = array.new_line()
var int[] bearFVGIds = array.new_int()
var bool[] bearFVGTraded = array.new_bool()
var int[] bearFVGStartBarIdx = array.new_int()
var bool[] bearFVGInvalidated = array.new_bool()

var bool bearCanPlotFVG = false
var int bearReversalId = 0
var line bearLastLine = na
var label bearLastTriangle = na
var bool bearReversalComplete = false
var int bearPrevMinIdx = na
var bool bearPendingSignalFVG = false
var bool bearBrokeFirstBullOpen = false
var bool bearWaitingAfterFirstBreak = false
var bool bearJustEnteredIdle = false
var bool bearJustEnteredIdleHadSignal = false
var int bearReversalCompletedOn = na

// --- FIXED / MISSING declarations for bear side
var int bearReversalEndedOn = na
var int bearBarsAfterReversal = 0
var bool bearJustConfirmedReversal = false

// pending-signal arrays for bear side
var int[] bearSignalBars = array.new_int()
var int[] bearSignalReversalIds = array.new_int()
var bool[] bearSignalFVGCreated = array.new_bool()

// Arrays to track all drawn bear lines/triangles (declare once)
var line[] bearAllLines = array.new_line()
var label[] bearAllTriangles = array.new_label()

// --- helpers: candle classification
is_bear = close < open
is_bull = close > open
is_doji = open == close

// --- Alert conditions ---
alertcondition(not na(bullLastTriangle), title="Upward Triangle Alert", message="Bullish triangle condition met.")
alertcondition(not na(bearLastTriangle), title="Downward Triangle Alert", message="Bearish triangle condition met.")

// --- MAIN LOGIC ---